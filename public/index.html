<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jokes Service</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script> <!-- Include the Socket.IO client -->
</head>
<body>
  <h1>Jokes Service</h1>
  <select id="jokeType">
    <option value="any">Any Type</option>
  </select>
  <button onclick="getJoke()">Get Joke</button>
  <div id="jokeDisplay"></div>

  <script>
    const socket = io(); // Initialize a Socket.IO client

    // Function to load joke types
    function loadJokeTypes() {
      fetch('/type')
        .then(handleResponse)
        .then(types => {
          const select = document.getElementById('jokeType');
          // Clear existing options except for the first 'any' type
          let length = select.options.length;
          for (let i = length - 1; i > 0; i--) {
            select.options[i] = null;
          }
          // Add new types from response
          types.forEach(typeObj => {
            const option = document.createElement('option');
            option.value = typeObj.type;
            option.textContent = typeObj.type;
            select.appendChild(option);
          });
        })
        .catch(handleError);
    }

    // Function to get a random joke
    function getJoke() {
      const type = document.getElementById('jokeType').value;
      fetch(`/joke?type=${type}`)
        .then(handleResponse)
        .then(joke => {
          const display = document.getElementById('jokeDisplay');
          if(joke.setup && joke.punchline) {
            display.textContent = joke.setup + ' ' + joke.punchline;
          } else {
            display.textContent = 'No joke found for the selected type.';
          }
        })
        .catch(handleError);
    }

    // Handle fetch response
    function handleResponse(response) {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    }

    // Handle errors
    function handleError(error) {
      const display = document.getElementById('jokeDisplay');
      display.textContent = 'Error: ' + error.message;
      console.error('Fetch error:', error);
    }

    // Listen for live updates of new jokes
    socket.on('new_joke', (joke) => {
      // You can modify this part to decide how you want to display the live updates
      console.log('New joke received:', joke);
      const display = document.getElementById('jokeDisplay');
      display.textContent = joke.setup + ' ' + joke.punchline; // Example of displaying the latest joke
    });

    // Load joke types on page load
    loadJokeTypes();

    // Poll server for new joke types every 30 seconds
    setInterval(loadJokeTypes, 30000);
  </script>
</body>
</html>
